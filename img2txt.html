<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canvas Image Processing</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    canvas {
      border: 1px solid #000;
      margin-bottom: 10px;
    }
    textarea {
      width: 100%;
      height: 50%;
      resize: none;
    }
  </style>
</head>
<body>
  <canvas id="canvas" width="144" height="144"></canvas>
  <textarea id="output" readonly></textarea>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const textarea = document.getElementById('output');

    // Helper function to get grayscale value
    const getGrayscale = (r, g, b) => Math.round(0.299 * r + 0.587 * g + 0.114 * b);

    // Map grayscale values to 'a', 'b', 'c', 'd'
    const mapToChar = (gray, thresholds) => {
      if (gray <= thresholds[0]) return 'a';
      if (gray <= thresholds[1]) return 'b';
      if (gray <= thresholds[2]) return 'c';
      return 'd';
    };

    // Generate thresholds for grayscale levels
    const generateThresholds = (sortedGrays) => {
      const step = Math.floor(sortedGrays.length / 4);
      return [
        sortedGrays[step - 1],
        sortedGrays[2 * step - 1],
        sortedGrays[3 * step - 1]
      ];
    };

    // Convert image to compressed string
    const compressString = (pixels) => {
      let compressed = '';
      let lastChar = pixels[0];
      let count = 1;

      for (let i = 1; i < pixels.length; i++) {
        if (pixels[i] === lastChar) {
          count++;
        } else {
          compressed += lastChar + (count > 1 ? count : '');
          lastChar = pixels[i];
          count = 1;
        }
      }

      // Append the last character group
      compressed += lastChar + (count > 1 ? count : '');
      return compressed;
    };

    // Convert image to string
    const imageToString = (imageData) => {
      const { data, width, height } = imageData;
      const grayscaleValues = [];
      const pixels = [];

      // Extract grayscale values
      for (let i = 0; i < data.length; i += 4) {
        grayscaleValues.push(getGrayscale(data[i], data[i + 1], data[i + 2]));
      }

      // Generate thresholds based on unique grayscale values
      const sortedGrays = Array.from(new Set(grayscaleValues)).sort((a, b) => a - b);
      const thresholds = generateThresholds(sortedGrays);

      // Map pixels to characters
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const index = y * width + x;
          const gray = grayscaleValues[index];
          pixels.push(mapToChar(gray, thresholds));
        }
      }

      // Compress the string
      return compressString(pixels);
    };

    // Draw the uploaded image on the canvas
    const drawImageOnCanvas = (file) => {
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Get image data
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // Convert image to compressed string and update textarea
        const resultString = imageToString(imageData);
        textarea.value = resultString;
      };
      img.src = URL.createObjectURL(file);
    };

    // Canvas click event to upload and process image
    canvas.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (event) => {
        const file = event.target.files[0];
        if (file) drawImageOnCanvas(file);
      };
      input.click();
    });
  </script>
</body>
</html>
